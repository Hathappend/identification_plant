<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlantLens Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #00d26a; --bg: #0f172a; --glass: rgba(20, 20, 20, 0.85); --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- INTRO SCREEN --- */
        #intro {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b); z-index: 99;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .logo { font-size: 50px; margin-bottom: 10px; filter: drop-shadow(0 0 20px rgba(0,210,106,0.4)); }
        
        button#start-btn {
            padding: 16px 45px; background: var(--primary); border: none; border-radius: 50px;
            font-weight: 600; font-size: 16px; margin-top: 30px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 210, 106, 0.5); transform: scale(1); transition: 0.2s;
        }
        button#start-btn:active { transform: scale(0.95); }

        /* --- APP SCREEN --- */
        #app { display: none; flex-direction: column; height: 100%; position: relative; }

        /* Header */
        .header {
            position: absolute; top: 20px; left: 0; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
        }
        .badge { 
            background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 20px; 
            font-size: 12px; font-weight: 600; text-transform: uppercase; 
            border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(4px);
        }
        
        /* Button Group (Switch & Upload) */
        .btn-group { display: flex; gap: 10px; }

        .btn-icon {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: 0.3s;
        }
        .btn-icon svg { width: 22px; fill: white; }
        .btn-icon:active { transform: scale(0.9); background: var(--primary); }

        /* Camera Wrapper */
        #cam-wrapper { 
            flex: 1; background: #000; position: relative; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        
        /* Video Canvas (Kamera) */
        canvas { width: 100%; height: 100%; object-fit: cover; }
        
        /* Image Preview (Upload) */
        #uploaded-image {
            width: 100%; height: 100%; object-fit: contain; /* Biar gambar terlihat utuh */
            display: none; position: absolute; z-index: 5; background: #000;
        }

        /* Tombol Close Gambar */
        #close-img-btn {
            position: absolute; top: 80px; right: 20px; z-index: 30;
            background: rgba(255,0,0,0.8); color: white; border-radius: 50%;
            width: 35px; height: 35px; display: none; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; border: 2px solid white;
        }

        .scan-line {
            position: absolute; width: 100%; height: 2px; background: var(--primary);
            box-shadow: 0 0 15px var(--primary); top: 10%;
            animation: scan 2.5s infinite ease-in-out; opacity: 0.8;
            pointer-events: none; z-index: 10;
        }
        @keyframes scan { 0% {top: 15%; opacity: 0;} 20% {opacity: 1;} 80% {opacity: 1;} 100% {top: 85%; opacity: 0;} }

        /* Result Panel */
        #result {
            position: absolute; bottom: 0; width: 100%;
            background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 25px 25px 0 0; padding: 25px 20px 40px 20px;
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-top: 1px solid rgba(255,255,255,0.1); z-index: 40;
        }
        
        .row { margin-bottom: 14px; }
        .row-head { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; }
        .name { font-weight: 600; text-transform: capitalize; letter-spacing: 0.5px; }
        .perc { font-weight: bold; color: var(--primary); font-size: 14px; }
        .bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; border-radius: 10px; }

        #warning {
            position: fixed; top: 0; width: 100%; background: #e11d48; color: white;
            text-align: center; padding: 10px; font-size: 13px; z-index: 9999; display: none; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="warning">‚ö†Ô∏è Wajib HTTPS (Ngrok) / Localhost</div>

    <input type="file" id="file-input" accept="image/*" style="display: none;">

    <div id="intro">
        <div class="logo">üåø</div>
        <h2 style="margin:0; font-size:28px;">PlantLens</h2>
        <p style="color:#aaa; font-size:14px; margin-top:5px">AI Camera & Gallery</p>
        <button id="start-btn" onclick="init()">MULAI</button>
        <p id="status" style="margin-top:20px; font-size:13px; color:var(--primary); display:none; font-weight:600">Memuat...</p>
    </div>

    <div id="app">
        <div class="header">
            <span class="badge" id="mode-badge">Live AI</span>
            
            <div class="btn-group">
                <div class="btn-icon" onclick="triggerUpload()">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </div>
                <div class="btn-icon" id="btn-switch" onclick="switchCamera()">
                    <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                </div>
            </div>
        </div>

        <div id="close-img-btn" onclick="closeImageMode()">‚úï</div>

        <div id="cam-wrapper">
            <img id="uploaded-image" src="" alt="Preview">
            
            <div class="scan-line"></div>
        </div>

        <div id="result">
            <div style="margin-bottom:15px; text-transform:uppercase; font-size:11px; color:#888; letter-spacing:1px; font-weight:600">Hasil Deteksi</div>
            <div id="labels"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        const URL = "./my_model/";
        const PREDICTION_INTERVAL = 300; 

        let model, webcam, labelContainer, maxPredictions;
        let isRunning = false;
        let lastTime = 0;
        let isPredicting = false; 
        
        // Mode State
        let isImageMode = false; // False = Kamera, True = Upload Gambar

        // Vars Kamera
        let videoDevices = [];
        let currentDeviceIndex = 0;
        let currentDeviceId = null;

        // --- INIT & SETUP ---
        window.onload = () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('warning').style.display = 'block';
            }
            
            // Listener untuk upload file
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
        };

        async function init() {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').innerText = "Memuat Model AI...";

            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
            } catch (e) {
                alert("Error: Folder 'my_model' bermasalah.");
                location.reload(); return;
            }

            document.getElementById('status').innerText = "Menyiapkan Kamera...";
            await initCameraList(); 
            await loadCamera(currentDeviceId); 

            setupLabels();
            isRunning = true;
            window.requestAnimationFrame(loop);

            // Transisi Masuk
            document.getElementById('intro').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('intro').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                setTimeout(() => document.getElementById('result').style.transform = 'translateY(0)', 100);
            }, 500);
        }

        // --- LOOP (Hanya jalan saat Mode Kamera) ---
        async function loop(timestamp) {
            // Kalau lagi mode gambar upload, stop update kamera & prediksi berulang
            if (isImageMode) {
                // Tetap request frame agar bisa resume nanti, tapi jangan lakukan apa-apa
                if (isRunning) window.requestAnimationFrame(loop);
                return;
            }

            webcam.update(); // Update video frame

            if (timestamp - lastTime > PREDICTION_INTERVAL && !isPredicting) {
                isPredicting = true; 
                try {
                    await predict(webcam.canvas); // Prediksi Video
                } catch (err) {
                    console.error("AI Error:", err);
                } finally {
                    isPredicting = false;
                    lastTime = timestamp;
                }
            }

            if (isRunning) window.requestAnimationFrame(loop);
        }

        // --- FUNGSI PREDIKSI (Bisa Video / Gambar) ---
        async function predict(inputElement) {
            if (!inputElement) return;
            
            const prediction = await model.predict(inputElement);

            for (let i = 0; i < maxPredictions; i++) {
                const name = prediction[i].className.replace(/_/g, " ");
                const prob = prediction[i].probability;
                const perc = Math.round(prob * 100) + "%";

                const row = labelContainer.childNodes[i];
                row.querySelector(".name").innerText = name;
                row.querySelector(".perc").innerText = perc;
                
                const bar = row.querySelector(".bar-fill");
                bar.style.width = perc;

                // Indikator Warna
                if (prob > 0.85) { 
                    bar.style.background = "#00d26a"; 
                    row.querySelector(".perc").style.color = "#00d26a";
                    row.style.opacity = 1;
                } else if (prob > 0.4) { 
                    bar.style.background = "#fbbf24"; 
                    row.querySelector(".perc").style.color = "#fbbf24";
                    row.style.opacity = 0.8;
                } else { 
                    bar.style.background = "#64748b"; 
                    row.querySelector(".perc").style.color = "#64748b";
                    row.style.opacity = 0.4;
                }
            }
        }

        // --- LOGIC UPLOAD GAMBAR ---
        function triggerUpload() {
            document.getElementById('file-input').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // 1. Set Gambar
                const img = document.getElementById('uploaded-image');
                img.src = e.target.result;
                img.style.display = 'block';

                // 2. Ubah UI ke Mode Gambar
                isImageMode = true;
                document.getElementById('mode-badge').innerText = "Gallery Mode";
                document.getElementById('close-img-btn').style.display = 'flex'; // Munculkan tombol close
                
                // 3. Sembunyikan Canvas Kamera (Opsional, ditimpa img juga gak masalah)
                if (webcam.canvas) webcam.canvas.style.display = 'none';

                // 4. Lakukan Prediksi SEKALI saja pada gambar
                img.onload = function() {
                    predict(img); 
                }
            };
            reader.readAsDataURL(file);
        }

        function closeImageMode() {
            // 1. Reset UI ke Mode Kamera
            isImageMode = false;
            document.getElementById('mode-badge').innerText = "Live AI";
            
            // 2. Sembunyikan Gambar & Tombol Close
            document.getElementById('uploaded-image').style.display = 'none';
            document.getElementById('close-img-btn').style.display = 'none';
            document.getElementById('file-input').value = ""; // Reset input biar bisa pilih file sama

            // 3. Munculkan Kamera lagi
            if (webcam.canvas) webcam.canvas.style.display = 'block';
        }

        // --- SYSTEM KAMERA ---
        async function initCameraList() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                stream.getTracks().forEach(track => track.stop());

                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(d => d.kind === 'videoinput');
                const backCams = videoDevices.filter(d => {
                    const l = d.label.toLowerCase();
                    return l.includes('back') || l.includes('belakang') || l.includes('environment');
                });
                const mainCam = backCams.find(d => {
                    const l = d.label.toLowerCase();
                    return !l.includes('wide') && !l.includes('ultra') && !l.includes('0.5');
                });

                if (mainCam) {
                    currentDeviceId = mainCam.deviceId;
                    currentDeviceIndex = videoDevices.indexOf(mainCam);
                } else if (backCams.length > 0) {
                    currentDeviceId = backCams[0].deviceId;
                    currentDeviceIndex = videoDevices.indexOf(backCams[0]);
                } else {
                    currentDeviceId = videoDevices[0].deviceId; 
                }
            } catch (e) { console.log("Cam Init Error"); }
        }

        async function loadCamera(deviceId) {
            if (webcam && webcam.stop) webcam.stop();

            const width = 500; const height = 500; const flip = false;
            webcam = new tmImage.Webcam(width, height, flip);

            try {
                if (deviceId) await webcam.setup({ deviceId: { exact: deviceId } });
                else await webcam.setup({ facingMode: "environment" });
            } catch (e) { await webcam.setup(); }
            
            await webcam.play();
            
            const wrapper = document.getElementById('cam-wrapper');
            // Hati-hati jangan hapus img upload saat reset kamera
            const imgUpload = document.getElementById('uploaded-image');
            wrapper.innerHTML = ""; 
            wrapper.appendChild(webcam.canvas);
            wrapper.appendChild(imgUpload); // Masukkan lagi img upload
            
            const scanLine = document.createElement('div');
            scanLine.className = 'scan-line';
            wrapper.appendChild(scanLine);
        }

        async function switchCamera() {
            // Jangan ganti kamera kalau lagi lihat gambar
            if (isImageMode) return; 

            if (videoDevices.length < 2) return;
            currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
            currentDeviceId = videoDevices[currentDeviceIndex].deviceId;
            await loadCamera(currentDeviceId);
        }

        function setupLabels() {
            labelContainer = document.getElementById("labels");
            labelContainer.innerHTML = "";
            for (let i = 0; i < maxPredictions; i++) {
                let div = document.createElement("div");
                div.className = "row";
                div.innerHTML = `
                    <div class="row-head"><span class="name">Loading...</span><span class="perc">0%</span></div>
                    <div class="bar-bg"><div class="bar-fill"></div></div>
                `;
                labelContainer.appendChild(div);
            }
        }
    </script>
</body>
</html>